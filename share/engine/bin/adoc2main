#!/bin/sh
# Parse an asciidoctor fragment into a main-like HTML fragment.
#
# Usage: $0 <context-filepath> <input-filepath> [<id-prefix>] < <input-filehandle>
#
# context-filepath
#   JSON context/config dictionary. Keys we use:
#
#   (none currently)
#
# input-filepath
#   Path to the input source file. This is used for metadata purposes ONLY.
#   The actual file is not read directly; instead we expect either the whole
#   file or a portion of it to be passed via stdin. This allows us to support
#   (e.g.) *.j2 templates that call us selectively for portions of itself.
#
# id_prefix
#   Passed directly to asciidoctor.

DIR="$(mktemp -d)"
cleanup() { rm -rf "$DIR"; }
trap 'cleanup; trap - EXIT;' EXIT HUP INT QUIT PIPE TERM
mkfifo "$DIR/pipe"

# asciidoctor treats the level-0 heading in a special way
# we don't like that and it's inconsistent with other document formats, so we
# do a conjugation-like (group theory gag^-1) trick

fwd() {
  # in adoc, convert the first level-0 heading into a level-1 heading
  sed -r -e '0,/^= (.*)/s//== \1/w '"$DIR/pipe"
}

rev() {
  read x < "$DIR/pipe"
  if [ -z "$x" ]; then
    cat
  else
    # if fwd applied then
    # in html, convert the first level-1 heading into a level-0 heading
    # also drop the first entry of any toc
    sed -r \
      -e '0,/div class="sect1"/s//div class="sect0"/' \
      -e '/\bsectlevel1\b/,/\bhref=/{s/\bhref=//;T;d;q}' \
      -e '0,/<h2(.*)<\/h2>/s//<h1\1<\/h1>/'
  fi
}

if gem list --silent -i -v ">= 0.1003" '^asciidoctor-mathematical$'; then
  args="$args -a stem -r asciidoctor-mathematical -a mathematical-format=mathml -a mathematical-inline=true"
fi

ctxfile="$1" # TODO: read extra args from this file, document this & the docutils version too
infile="$2"
idprefix="$3"
cancellink='<a class="anchor-cancel" href="#" title="Cancel anchor target"></a>'

# set idprefix from parameter
# set idseparator to be more consistent with docutils
fwd | \
asciidoctor -a sectanchors -a idprefix="${idprefix:+${idprefix}_}" -a idseparator=- \
  -a toc=macro -a toc-title=Contents $args -s -o - - | \
rev | \
sed -e 's/class="sect/class="main-asciidoc sect/g' \
  -e 's;<a class="anchor";'"${cancellink}"'<a class="anchor";g'
